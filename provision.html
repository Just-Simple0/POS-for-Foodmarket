<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>POS System - Provision</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- ⚡️ 테마 초기 적용(FOUC 방지) -->
    <script>
      (function () {
        try {
          var t = localStorage.getItem("theme");
          var d = t
            ? t === "dark"
            : window.matchMedia &&
              window.matchMedia("(prefers-color-scheme: dark)").matches;
          if (d) document.documentElement.classList.add("dark");
        } catch (e) {}
      })();
    </script>

    <!-- 공통 parts 삽입 -->
    <link rel="stylesheet" href="css/tw.css" />
    <link rel="stylesheet" href="css/common.css" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.min.css"
    />

    <script>
      window.CF_TURNSTILE_SITEKEY = "0x4AAAAAABtE3GFMWF3_Fd4E";
    </script>
    <!-- SheetUS 삽입 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase parts 삽입 -->
    <script type="module" src="js/components/firebase-config.js"></script>

    <!-- 개별 css, js 삽입 -->
    <link rel="stylesheet" href="css/provision.css" />
    <script type="module" src="js/provision.js" defer></script>
  </head>

  <body>
    <div id="header-container"></div>

    <main class="container">
      <div class="tabs">
        <button class="tab-btn active" data-tab="provision">
          <i class="fas fa-cash-register"></i> 제공 등록
        </button>
        <button class="tab-btn" data-tab="exchange">
          <i class="fas fa-right-left"></i> 교환
        </button>
      </div>
      <!-- ===== 제공 등록 패널 ===== -->
      <section id="provision-panel" data-tab-panel="provision">
        <h3>이용자 조회(제공)</h3>
        <section id="prov-customer-lookup">
          <input
            type="text"
            id="prov-customer-search"
            class="input w-72 md:w-96"
            placeholder="예: 홍길동"
          />
          <button id="prov-lookup-btn" type="button" class="btn">
            <i class="fas fa-search"></i> 조회
          </button>
        </section>

        <!-- ✅ 방문자 리스트 (여러 명 담아두고 선택) -->
        <section id="visitor-list-section" class="hidden">
          <h3>방문자 리스트</h3>
          <ul id="visitor-list" class="visitor-list"></ul>
        </section>

        <section id="customer-if">
          <div id="provision-customer-info" class="hidden card card-body">
            <!-- 제공 탭 고객 정보 -->
          </div>
        </section>

        <!-- ✅ 상품 선택 영역 -->
        <section id="product-selection" class="hidden">
          <h3>상품 추가</h3>

          <div class="product-input-area">
            <!-- 바코드 전용 입력 -->
            <input
              type="text"
              id="barcode-input"
              class="input w-64 md:w-72"
              placeholder="바코드 입력 (Enter)"
              inputmode="numeric"
              pattern="\\d*"
            />
            <!-- 상품명 전용 입력 + 자동완성 -->
            <div class="autocomplete-wrapper">
              <input
                type="text"
                id="name-input"
                class="input w-64 md:w-72"
                placeholder="상품명 입력 (Enter → 수량)"
              />
              <div
                id="autocomplete-list"
                class="autocomplete-list hidden"
              ></div>
            </div>
            <!-- 수량 -->
            <input
              type="number"
              id="quantity-input"
              class="input w-24"
              placeholder="수량 (기본 1)"
              min="1"
              max="30"
            />
            <button id="add-product-btn" class="btn">
              <i class="fas fa-plus-circle"></i> 추가
            </button>
          </div>

          <div class="selected-products table-wrapper">
            <table id="selected-table" class="table">
              <thead>
                <tr>
                  <th>상품명</th>
                  <th>수량</th>
                  <th>단가</th>
                  <th>총가격</th>
                  <th>관리</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div id="total-summary">
              총 합계: <span id="total-points">0</span> 포인트
              <span id="point-warning" class="hidden"
                >⚠ 포인트 초과 (최대 30)</span
              >
            </div>
          </div>
        </section>

        <!-- ✅ 제출 버튼 -->
        <section id="submit-section" class="hidden">
          <button id="submit-btn" class="btn">
            <i class="fas fa-check-circle"></i> 제공 등록 완료
          </button>
          <label for="lifelove-checkbox">
            <input type="checkbox" id="lifelove-checkbox" /> 생명사랑 제공
          </label>
        </section>

        <!-- 🔁 기능 버튼들 (상품 테이블 하단) -->
        <div
          id="product-action-buttons"
          style="margin-top: 1rem; display: flex; gap: 10px"
        >
          <button id="undo-btn" class="btn btn-outline small-btn">
            <i class="fas fa-rotate-left"></i>
          </button>
          <button id="redo-btn" class="btn btn-outline small-btn">
            <i class="fas fa-rotate-right"></i>
          </button>
          <button id="clear-products-btn" class="btn btn-outline">
            <i class="fas fa-broom"></i> 물품 초기화
          </button>
          <button id="clear-all-btn" class="btn btn--danger">
            <i class="fas fa-trash-alt"></i> 전체 초기화
          </button>
          <!-- ✅ 보류(임시 저장/불러오기: localStorage) -->
          <button
            id="hold-save-btn"
            class="btn btn-outline"
            title="현재 선택 방문자의 장바구니를 임시 저장"
          >
            <i class="fas fa-pause-circle"></i> 보류 저장
          </button>
          <button
            id="hold-load-btn"
            class="btn btn-outline"
            title="임시 저장된 장바구니 불러오기"
          >
            <i class="fas fa-play-circle"></i> 보류 불러오기
          </button>
        </div>
      </section>

      <!-- ===== 교환 패널 (최근 50일) ===== -->
      <section id="exchange-section" data-tab-panel="exchange" class="hidden">
        <h3>이용자 조회(교환)</h3>
        <section id="ex-customer-lookup">
          <input
            type="text"
            id="ex-customer-search"
            class="input w-72 md:w-96"
            placeholder="예: 홍길동"
          />
          <button id="ex-lookup-btn" class="btn" type="button">
            <i class="fas fa-search"></i> 조회
          </button>
        </section>

        <section id="exchange-customer-if">
          <div id="exchange-customer-info" class="hidden">
            <!-- 교환 탭 고객 정보 -->
          </div>
        </section>

        <section id="exchange-history-section" class="hidden">
          <!-- ✅ 최근 50일 내 제공내역 테이블 -->
          <h3>교환 (최근 50일, 환불 없음)</h3>
          50일 이내 제공내역에서 교환할 내역을 선택하세요.
          <div class="table-wrapper">
            <table id="exchange-history-table" class="table">
              <thead>
                <tr>
                  <th>일시</th>
                  <th>항목수</th>
                  <th>합계</th>
                  <th>비고</th>
                  <th>선택</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <div id="exchange-builder" class="hidden" style="margin-top: 1rem">
          <h3>교환 편집</h3>
          <div class="product-input-area">
            <input
              type="text"
              id="ex-barcode-input"
              class="input w-64 md:w-72"
              placeholder="바코드 입력 (Enter)"
              inputmode="numeric"
              pattern="\\d*"
            />
            <div class="autocomplete-wrapper">
              <input
                type="text"
                id="ex-name-input"
                class="input w-64 md:w-72"
                placeholder="상품명 입력"
              />
              <div
                class="autocomplete-list hidden"
                id="ex-autocomplete"
                style="display: none"
              ></div>
            </div>
            <input
              type="number"
              id="ex-quantity-input"
              class="input w-24"
              placeholder="수량 (기본 1)"
              min="1"
              max="30"
            />
            <button id="ex-add-product-btn" class="btn">
              <i class="fas fa-plus-circle"></i> 추가
            </button>
          </div>

          <div class="selected-products table-wrapper">
            <table id="exchange-table" class="table">
              <thead>
                <tr>
                  <th>상품명</th>
                  <th>수량</th>
                  <th>단가</th>
                  <th>총가격</th>
                  <th>관리</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div id="total-summary">
              기존 합계: <b id="ex-original-total">0</b> | 교환 합계:
              <b id="ex-new-total">0</b>
              <span id="ex-warning" class="hidden"
                >⚠ 교환 합계는 기존 합계 이내이며, 최대 30 포인트입니다.</span
              >
            </div>
          </div>

          <div style="margin-top: 10px">
            <button id="exchange-submit-btn" class="btn">
              <i class="fas fa-right-left"></i> 교환 확정
            </button>
          </div>
        </div>
      </section>
    </main>

    <div id="footer-container"></div>

    <!-- ✅ 동명이인 선택 모달 -->
    <div id="duplicate-modal" class="modal hidden">
      <div class="modal-content">
        <h2>이용자 선택</h2>
        <ul id="duplicate-list">
          <!-- 동적으로 후보 리스트 삽입 -->
        </ul>
        <div
          id="selected-info"
          class="hidden"
          style="margin-top: 1rem; font-size: 0.9rem"
        ></div>

        <div class="modal-buttons">
          <button
            id="confirm-duplicate"
            class="btn"
            type="button"
            title="방문자 리스트에 추가"
          >
            <i class="fas fa-check"></i> 삽입
          </button>
          <button
            id="close-duplicate-modal"
            class="btn btn-outline"
            type="button"
          >
            <i class="fas fa-times"></i> 닫기
          </button>
        </div>
      </div>
    </div>

    <!-- ✅ 상품 빠른 등록 모달 (바코드 미등록 시 호출) -->
    <div
      id="quick-create-modal"
      class="modal hidden modal--quick"
      aria-hidden="true"
    >
      <div
        class="modal-content"
        role="dialog"
        aria-modal="true"
        aria-labelledby="qc-title"
      >
        <h2 id="qc-title"><i class="fas fa-bolt"></i> 상품 빠른 등록</h2>
        <div class="grid2" style="margin-top: 10px">
          <label
            ><span>상품명</span>
            <input type="text" id="qc-name" />
          </label>
          <label
            ><span>분류</span>
            <input type="text" id="qc-category" placeholder="예: 음료, 과자" />
          </label>
          <label
            ><span>가격</span>
            <input
              type="number"
              id="qc-price"
              min="0"
              step="0.5"
              placeholder="예: 0 또는 0.5 단위"
            />
          </label>
          <label
            ><span>바코드(EAN-13)</span>
            <input type="text" id="qc-barcode" inputmode="numeric" />
          </label>
        </div>
        <div class="modal-buttons">
          <button type="button" id="qc-save" class="btn btn-primary">
            <i class="fas fa-save"></i> 저장
          </button>
          <button type="button" id="qc-close" class="btn">
            <i class="fas fa-times"></i> 닫기
          </button>
        </div>
      </div>
    </div>

    <!-- Header/Footer 삽입 -->
    <script type="module">
      import { loadHeader, loadFooter } from "./js/components/comp.js";
      loadHeader("header-container");
      loadFooter("footer-container");
    </script>
  </body>
</html>
