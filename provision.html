<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>POS System - Provision</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script>
      (function () {
        try {
          var t = localStorage.getItem("theme");
          var d = t
            ? t === "dark"
            : window.matchMedia &&
              window.matchMedia("(prefers-color-scheme: dark)").matches;
          if (d) document.documentElement.classList.add("dark");
        } catch (e) {}
      })();
    </script>

    <link rel="stylesheet" href="css/common.css" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.min.css"
    />

    <script>
      window.CF_TURNSTILE_SITEKEY = "0x4AAAAAABtE3GFMWF3_Fd4E";
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module" src="js/components/firebase-config.js"></script>

    <link rel="stylesheet" href="css/provision.css" />
    <script type="module" src="js/provision.js" defer></script>
    <link rel="stylesheet" href="css/tw.css" />
  </head>

  <body>
    <div id="header-container"></div>

    <main class="container mx-auto px-4 py-6 space-y-6">
      <div class="flex flex-wrap items-center gap-2">
        <button
          class="tab-btn btn btn-light rounded-full text-sm font-semibold shadow-soft border border-slate-200 text-slate-800 hover:bg-primary-weak hover:border-primary/50 hover:text-primary [&.active]:bg-primary [&.active]:text-white [&.active]:border-primary active"
          data-tab="provision"
        >
          <i class="fas fa-cash-register"></i> 이용자 조회(제공)
        </button>
        <button
          class="tab-btn btn btn-light rounded-full text-sm font-semibold shadow-soft border border-slate-200 text-slate-800 hover:bg-primary-weak hover:border-primary/50 hover:text-primary [&.active]:bg-primary [&.active]:text-white [&.active]:border-primary"
          data-tab="exchange"
        >
          <i class="fas fa-right-left"></i> 교환
        </button>
      </div>

      <section
        id="provision-panel"
        data-tab-panel="provision"
        class="space-y-6"
      >
        <h3 class="text-xl font-bold text-slate-900 tracking-tight">
          이용자 조회(제공)
        </h3>
        <section
          id="prov-customer-lookup"
          class="card flex flex-wrap items-center gap-3 justify-between"
        >
          <input
            type="text"
            id="prov-customer-search"
            class="input w-full md:w-96 flex-1 min-w-[220px]"
            placeholder="고객명 검색"
          />
          <button id="prov-lookup-btn" type="button" class="btn btn-basic">
            <i class="fas fa-search"></i> 조회
          </button>
        </section>

        <section id="visitor-list-section" class="hidden card space-y-4">
          <h3 class="text-lg font-semibold text-slate-900 tracking-tight">
            방문자 리스트
          </h3>
          <ul
            id="visitor-list"
            class="visitor-list grid grid-cols-1 md:grid-cols-2 gap-2 list-none p-0 m-0"
          ></ul>
        </section>

        <section id="customer-if">
          <div
            id="provision-customer-info"
            class="hidden card space-y-2 text-slate-800"
          >
            <!-- 제공 대상 고객 정보 -->
          </div>
        </section>

        <section id="product-selection" class="hidden card space-y-4">
          <h3 class="text-lg font-semibold text-slate-900 tracking-tight">
            상품 추가
          </h3>

          <div
            class="product-input-area flex flex-wrap items-center gap-3 rounded-xl border border-slate-200 bg-neutral-weak/70 p-3"
          >
            <input
              type="text"
              id="barcode-input"
              class="input w-full sm:w-64 md:w-72"
              placeholder="바코드 입력 (Enter)"
              inputmode="numeric"
              pattern="\\d*"
            />
            <div class="autocomplete-wrapper relative flex-1 min-w-[16rem]">
              <input
                type="text"
                id="name-input"
                class="input w-full"
                placeholder="상품명 입력 (Enter 후 수량)"
              />
              <div
                id="autocomplete-list"
                class="autocomplete-list hidden absolute left-0 top-full z-50 mt-1 w-full max-h-52 overflow-y-auto rounded-lg border border-slate-200 bg-white shadow-input"
              ></div>
            </div>
            <input
              type="number"
              id="quantity-input"
              class="input w-24"
              placeholder="수량 (기본 1)"
              min="1"
              max="30"
            />
            <button id="add-product-btn" class="btn btn-basic">
              <i class="fas fa-plus-circle"></i> 추가
            </button>
          </div>

          <div class="selected-products table-wrapper">
            <table id="selected-table" class="table min-w-[720px]">
              <thead>
                <tr>
                  <th class="text-left">상품명</th>
                  <th class="text-center">수량</th>
                  <th class="text-center">가격</th>
                  <th class="text-center">총합계</th>
                  <th class="text-center">관리</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div
              id="total-summary"
              class="mt-4 flex flex-wrap items-center gap-3 text-lg font-bold text-slate-900"
            >
              현재 총계: <span id="total-points">0</span> 포인트
              <span id="point-warning" class="hidden text-danger font-bold"
                >총 포인트 초과 (최대 30)</span
              >
            </div>
          </div>
          <section id="submit-section" class="flex items-center gap-3" hidden>
            <button id="submit-btn" class="btn btn-basic">
              <i class="fas fa-check-circle"></i> 제공 등록 완료
            </button>
            <label
              for="lifelove-checkbox"
              class="flex items-center gap-2 text-slate-800"
            >
              <input type="checkbox" id="lifelove-checkbox" class="h-4 w-4" />
              생명사랑 제공
            </label>
          </section>
        </section>

        <div
          id="product-action-buttons"
          class="mt-4 flex flex-wrap items-center gap-3 card"
        >
          <button
            id="undo-btn"
            class="btn btn-dark-weak !px-3 !py-2 text-sm"
            aria-label="되돌리기"
          >
            <i class="fas fa-rotate-left"></i>
          </button>
          <button
            id="redo-btn"
            class="btn btn-dark-weak !px-3 !py-2 text-sm"
            aria-label="다시 실행"
          >
            <i class="fas fa-rotate-right"></i>
          </button>
          <button id="clear-products-btn" class="btn btn-dark-weak text-sm">
            <i class="fas fa-broom"></i> 물품 초기화
          </button>
          <button id="clear-all-btn" class="btn btn-danger text-sm">
            <i class="fas fa-trash-alt"></i> 전체 초기화
          </button>
          <button
            id="hold-save-btn"
            class="btn btn-dark-weak text-sm"
            title="현재 선택 방문자의 장바구니를 임시 저장"
          >
            <i class="fas fa-pause-circle"></i> 보류 저장
          </button>
          <button
            id="hold-load-btn"
            class="btn btn-dark-weak text-sm"
            title="임시 저장된 장바구니 불러오기"
          >
            <i class="fas fa-play-circle"></i> 보류 불러오기
          </button>
        </div>
      </section>

      <section
        id="exchange-section"
        data-tab-panel="exchange"
        class="hidden space-y-6"
      >
        <h3 class="text-xl font-bold text-slate-900 tracking-tight">
          이용자 조회(교환)
        </h3>
        <section
          id="ex-customer-lookup"
          class="card flex flex-wrap items-center gap-3 justify-between"
        >
          <input
            type="text"
            id="ex-customer-search"
            class="input w-full md:w-96 flex-1 min-w-[220px]"
            placeholder="고객명 검색"
          />
          <button id="ex-lookup-btn" class="btn btn-basic" type="button">
            <i class="fas fa-search"></i> 조회
          </button>
        </section>

        <section id="exchange-customer-if">
          <div
            id="exchange-customer-info"
            class="hidden card space-y-2 text-slate-800"
          ></div>
        </section>

        <section id="exchange-history-section" class="hidden card space-y-4">
          <h3 class="text-lg font-semibold text-slate-900 tracking-tight">
            교환 (최근 50일 이내 제공 내역)
          </h3>
          <div class="table-wrapper overflow-x-auto">
            <table id="exchange-history-table" class="table min-w-[720px]">
              <thead>
                <tr>
                  <th class="text-left">일시</th>
                  <th class="text-center">개수</th>
                  <th class="text-center">합계</th>
                  <th class="text-center">비고</th>
                  <th class="text-center">선택</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <div id="exchange-builder" class="hidden card space-y-4">
          <h3 class="text-lg font-semibold text-slate-900 tracking-tight">
            교환 편집
          </h3>
          <div
            class="product-input-area flex flex-wrap items-center gap-3 rounded-xl border border-slate-200 bg-neutral-weak/70 p-3"
          >
            <input
              type="text"
              id="ex-barcode-input"
              class="input w-full sm:w-64 md:w-72"
              placeholder="바코드 입력 (Enter)"
              inputmode="numeric"
              pattern="\\d*"
            />
            <div class="autocomplete-wrapper relative flex-1 min-w-[16rem]">
              <input
                type="text"
                id="ex-name-input"
                class="input w-full"
                placeholder="상품명 입력"
              />
              <div
                class="autocomplete-list hidden absolute left-0 top-full z-50 mt-1 w-full max-h-52 overflow-y-auto rounded-lg border border-slate-200 bg-white shadow-input"
                id="ex-autocomplete"
              ></div>
            </div>
            <input
              type="number"
              id="ex-quantity-input"
              class="input w-24"
              placeholder="수량 (기본 1)"
              min="1"
              max="30"
            />
            <button id="ex-add-product-btn" class="btn btn-basic">
              <i class="fas fa-plus-circle"></i> 추가
            </button>
          </div>

          <div class="selected-products table-wrapper">
            <table id="exchange-table" class="table min-w-[720px]">
              <thead>
                <tr>
                  <th class="text-left">상품명</th>
                  <th class="text-center">수량</th>
                  <th class="text-center">가격</th>
                  <th class="text-center">총합계</th>
                  <th class="text-center">관리</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div
              id="total-summary"
              class="mt-4 flex flex-wrap items-center gap-3 text-lg font-bold text-slate-900"
            >
              기존 합계: <b id="ex-original-total">0</b> | 교환 합계:
              <b id="ex-new-total">0</b>
              <span id="ex-warning" class="hidden text-danger font-bold"
                >교환 합계는 기존 합계 이내며, 최대 30 포인트입니다.</span
              >
            </div>
          </div>

          <div class="mt-2">
            <button id="exchange-submit-btn" class="btn btn-basic">
              <i class="fas fa-right-left"></i> 교환 확정
            </button>
          </div>
        </div>
      </section>
    </main>

    <div id="footer-container"></div>

    <div id="duplicate-modal" class="modal hidden">
      <div class="modal-content">
        <h2>이용자 선택</h2>
        <ul id="duplicate-list" class="grid gap-3">
          <!-- 동적으로 후보 리스트 삽입 -->
        </ul>
        <div
          id="selected-info"
          class="hidden mt-4 text-sm text-slate-700"
        ></div>

        <div class="modal-buttons">
          <button
            id="confirm-duplicate"
            class="btn"
            type="button"
            title="방문자 리스트에 추가"
          >
            <i class="fas fa-check"></i> 선택
          </button>
          <button
            id="close-duplicate-modal"
            class="btn btn-light"
            type="button"
          >
            <i class="fas fa-times"></i> 닫기
          </button>
        </div>
      </div>
    </div>

    <div
      id="quick-create-modal"
      class="modal hidden modal--quick"
      aria-hidden="true"
    >
      <div
        class="modal-content"
        role="dialog"
        aria-modal="true"
        aria-labelledby="qc-title"
      >
        <h2 id="qc-title"><i class="fas fa-bolt"></i> 상품 빠른 등록</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">
          <label class="flex flex-col gap-1">
            <span>상품명</span>
            <input type="text" id="qc-name" class="input" />
          </label>
          <label class="flex flex-col gap-1">
            <span>분류</span>
            <input
              type="text"
              id="qc-category"
              class="input"
              placeholder="예: 음료, 과자"
            />
          </label>
          <label class="flex flex-col gap-1">
            <span>가격</span>
            <input
              type="number"
              id="qc-price"
              class="input"
              min="0"
              step="0.5"
              placeholder="예: 0 또는 0.5 단위"
            />
          </label>
          <label class="flex flex-col gap-1">
            <span>바코드(EAN-13)</span>
            <input
              type="text"
              id="qc-barcode"
              class="input"
              inputmode="numeric"
            />
          </label>
        </div>
        <div class="modal-buttons">
          <button type="button" id="qc-save" class="btn btn-basic">
            <i class="fas fa-save"></i> 저장
          </button>
          <button type="button" id="qc-close" class="btn btn-light">
            <i class="fas fa-times"></i> 닫기
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { loadHeader, loadFooter } from "./js/components/comp.js";
      loadHeader("header-container");
      loadFooter("footer-container");
    </script>
  </body>
</html>
