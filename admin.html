<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>POS System - Admin Setting</title>
    <!-- ⚡️ FOUC 방지: 초기 테마 적용 -->
    <script>
      (function () {
        try {
          var t = localStorage.getItem("theme");
          var d = t
            ? t === "dark"
            : window.matchMedia &&
              window.matchMedia("(prefers-color-scheme: dark)").matches;
          if (d) document.documentElement.classList.add("dark");
        } catch (e) {}
      })();
    </script>
    <!-- 공통 parts 삽입 -->
    <link rel="stylesheet" href="css/common.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.min.css"
    />
    <script>
      window.CF_TURNSTILE_SITEKEY = "0x4AAAAAABtE3GFMWF3_Fd4E";
    </script>
    <!-- XLSX (엑셀) -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
      defer
    ></script>
    <!-- firebase parts 삽입 -->
    <script type="module" src="js/components/firebase-config.js"></script>
    <link rel="stylesheet" href="css/admin.css" />
    <link rel="stylesheet" href="css/tw.css" />

    <!-- daterangepicker (statistics와 동일) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  </head>
  <body>
    <div id="header-container"></div>
    <main class="container">
      <!-- 탭바 -->
      <nav class="tabbar">
        <button class="tab tab-btn active" data-tab="users">사용자 관리</button>
        <button class="tab tab-btn" data-tab="approvals">승인 요청</button>
      </nav>

      <div id="tab-users">
        <h2>계정 관리 · 권한 부여</h2>

        <!-- (6) 요약 위젯 -->
        <section class="card counters">
          <div class="counter-card">
            <div class="k">오늘</div>
            <div class="v">
              <span id="c-roles">0</span> 역할변경 ·
              <span id="c-disable">0</span> 비활성 ·
              <span id="c-reset">0</span> 초기화 ·
              <span id="c-delete">0</span> 삭제
            </div>
          </div>
          <div class="counter-card">
            <div class="k">최근 7일</div>
            <span id="c7-roles">0</span> 역할변경 ·
            <span id="c7-disable">0</span> 비활성 ·
            <span id="c7-reset">0</span> 초기화 ·
            <span id="c7-delete">0</span> 삭제
          </div>
        </section>

        <section class="card">
          <!-- 필터 바 -->
          <div class="card-header admin-filterbar search-bar">
            <input
              id="q"
              type="text"
              placeholder="이메일/이름/UID 검색"
              class="input"
            />
            <select id="f-role" class="input">
              <option value="">역할(전체)</option>
              <option value="admin">admin</option>
              <option value="manager">manager</option>
              <option value="user">user</option>
              <option value="pending">pending</option>
            </select>
            <input
              id="f-provider"
              type="text"
              placeholder="수단 필터(ex: google)"
              class="input"
            />
            <select id="f-sort" class="input">
              <option value="lastSignInTime:desc">최근로그인 ↓</option>
              <option value="lastSignInTime:asc">최근로그인 ↑</option>
              <option value="email:asc">이메일 ↑</option>
              <option value="email:desc">이메일 ↓</option>
            </select>
            <button id="btn-search" class="btn">검색</button>
          </div>

          <!-- 액션 바 -->
          <div class="admin-actionbar">
            <label class="muted">선택: <span id="sel-count">0</span>명</label>
            <select id="bulk-role" class="input small">
              <option value="">역할 일괄 변경…</option>
              <option value="admin">admin</option>
              <option value="manager">manager</option>
              <option value="user">user</option>
              <option value="pending">pending</option>
            </select>
            <button id="btn-bulk-role" class="btn btn-ghost">적용</button>
            <button id="btn-disable" class="btn btn-ghost">비활성화</button>
            <button id="btn-enable" class="btn btn-ghost">활성화</button>
            <button id="btn-reset" class="btn btn-ghost">비번 초기화</button>
            <button id="btn-revoke" class="btn btn-ghost">전원 로그아웃</button>
            <button id="btn-export-xlsx" class="btn">XLSX 내보내기</button>
          </div>

          <div class="table-wrap">
            <table id="admin-user-table" class="table-base">
              <thead>
                <tr>
                  <th style="width: 36px">
                    <input id="chk-all" type="checkbox" />
                  </th>
                  <th>이메일</th>
                  <th>이름</th>
                  <th>역할</th>
                  <th>최근 로그인</th>
                  <th>수단</th>
                  <th>이상</th>
                  <th>작업</th>
                </tr>
              </thead>
              <tbody id="admin-user-tbody">
                <tr>
                  <td colspan="8">검색 후 결과가 표시됩니다.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="card-footer">
            <button id="btn-more" class="btn btn-ghost">더 보기</button>
          </div>
        </section>

        <!-- 로그 탐색 -->
        <section class="card" id="logs-card">
          <div class="card-header logs-filter search-bar">
            <h3>감사 로그(최근 60일)</h3>
            <div class="logs-filter">
              <input
                id="log-uid"
                class="input"
                type="text"
                placeholder="UID(선택)"
              />
              <select id="log-action" class="input">
                <option value="">액션(전체)</option>
                <option value="setRole">역할 설정</option>
                <option value="setRoleBulk">다량 역할 설정</option>
                <option value="disableUser">사용자 비활성화</option>
                <option value="enableUser">사용자 활성화</option>
                <option value="forcePasswordReset">강제 비밀번호 초기화</option>
              </select>
              <button id="btn-logs" class="btn">조회</button>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table-base" id="logs-table">
              <thead>
                <tr>
                  <th>시각</th>
                  <th>행위자</th>
                  <th>액션</th>
                  <th>대상</th>
                  <th>상태</th>
                </tr>
              </thead>
              <tbody id="logs-tbody">
                <tr>
                  <td colspan="5">필터 후 조회하세요.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
      <!-- ===== 승인/거부 탭 ===== -->
      <section class="card" id="approvals-card" hidden>
        <div class="card-header">
          <h3>승인 요청</h3>
          <div class="search-bar">
            <button id="apr-refresh" class="btn">새로고침</button>
            <button id="apr-approve" class="btn btn-ghost">선택 승인</button>
            <button id="apr-reject" class="btn btn-ghost">선택 거부</button>
          </div>
        </div>
        <div class="table-wrap">
          <table class="table-base" id="approvals-table">
            <thead>
              <tr>
                <th style="width: 36px">
                  <input type="checkbox" id="apr-all" />
                </th>
                <th style="width: 160px">요청시각</th>
                <th style="width: 220px">요청자</th>
                <th style="width: 140px">유형</th>
                <th style="width: 200px">대상</th>
                <th>내용</th>
                <th style="width: 180px">작업</th>
              </tr>
            </thead>
            <tbody id="approvals-tbody">
              <tr>
                <td colspan="7">대기중인 요청이 없습니다.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <hr
          style="margin: 16px 0; border: none; border-top: 1px solid #e5e7eb"
        />
        <div class="card-header" style="margin-top: 0">
          <h3>최근 활동 로그 (30일)</h3>
          <div class="search-bar">
            <button id="clogs-refresh" class="btn">조회</button>
          </div>
        </div>
        <div class="table-wrap">
          <table class="table-base" id="c-logs-table">
            <thead>
              <tr>
                <th style="width: 160px">시간</th>
                <th style="width: 220px">계정</th>
                <th style="width: 140px">유형</th>
                <th style="width: 220px">대상</th>
                <th>상세</th>
              </tr>
            </thead>
            <tbody id="c-logs-tbody">
              <tr>
                <td colspan="5">최근 30일 활동 로그가 없습니다.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- ===== 연간 백업/정리(관리자) ===== -->
      <section class="card" id="annual-card">
        <div class="card-header">
          <h3>연간 백업 / 데이터 정리</h3>
        </div>
        <div class="card-header filter-row">
          <div
            style="
              display: flex;
              gap: 0.5rem;
              align-items: center;
              flex-wrap: wrap;
            "
          >
            <label for="yr-start"><strong>기간</strong></label>
            <input
              id="yr-start"
              type="text"
              class="input"
              placeholder="시작일 (YYYY.MM.DD)"
            />
            <span class="range-divider"> ~ </span>
            <input
              id="yr-end"
              type="text"
              class="input"
              placeholder="종료일 (YYYY.MM.DD)"
            />
          </div>
          <button id="btn-annual-default" class="btn">
            전년도 3/1 ~ 당해 3/1
          </button>
        </div>
        <div class="card-header">
          <button id="btn-export-provisions-year" class="btn">
            제공 XLSX 내보내기
          </button>
          <button id="btn-export-visits-year" class="btn">
            방문 XLSX 내보내기
          </button>
        </div>
        <div class="card-header">
          <input
            id="purge-confirm"
            class="input"
            placeholder="삭제 확인문구: DELETE-DATA"
          />
          <button id="btn-purge-run" class="btn btn-warn">
            기간 데이터 삭제(관리자)
          </button>
        </div>
        <p style="padding: 0 16px 12px; color: #475569">
          주의: 삭제는 되돌릴 수 없습니다. 먼저 XLSX 백업을 내려받고, 관리자
          권한으로만 실행하세요.
        </p>
      </section>
    </main>

    <div id="footer-container"></div>

    <script type="module">
      import { loadHeader, loadFooter } from "./js/components/comp.js";
      import "./js/admin.js";
      loadHeader("header-container");
      loadFooter("footer-container");
    </script>
  </body>
</html>
