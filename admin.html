<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POS System - Admin Setting</title>
    <script>
      (function () {
        try {
          var t = localStorage.getItem("theme");
          var d = t
            ? t === "dark"
            : window.matchMedia &&
              window.matchMedia("(prefers-color-scheme: dark)").matches;
          if (d) document.documentElement.classList.add("dark");
        } catch (e) {}
      })();
    </script>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
      defer
    ></script>

    <script>
      window.CF_TURNSTILE_SITEKEY = "0x4AAAAAABtE3GFMWF3_Fd4E";
    </script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.min.css"
    />
    <link rel="stylesheet" href="css/tw.css" />
    <link rel="stylesheet" href="css/tw-input.css" />

    <script type="module" src="js/components/firebase-config.js"></script>
  </head>
  <body>
    <div id="header-container"></div>

    <div id="loading-overlay" class="loading-overlay">
      <div class="loading-box">
        <div class="tds-spinner"></div>
        <div class="loading-text">데이터를 불러오고 있어요</div>
      </div>
    </div>

    <main class="main-layout">
      <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
        <div>
          <h2
            class="text-2xl font-bold text-slate-900 dark:text-white tracking-tight"
          >
            관리자 설정
          </h2>
          <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">
            사용자 권한, 승인 요청, 시스템 로그 및 데이터 백업을 관리합니다.
          </p>
        </div>
      </div>

      <div class="flex justify-center">
        <div class="tabs-segmented">
          <button class="tab-item is-active" data-tab="users">
            <i class="fas fa-users-cog"></i>
            <span>사용자 관리</span>
          </button>
          <button class="tab-item" data-tab="approvals">
            <i class="fas fa-clipboard-check"></i>
            <span>승인 요청</span>
          </button>
        </div>
      </div>

      <div id="tab-users" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div
            class="card flex flex-col justify-center gap-1 p-5 relative overflow-hidden group"
          >
            <div class="text-sm font-bold text-slate-500 dark:text-slate-400">
              오늘 변동
            </div>
            <div
              class="flex flex-wrap items-baseline gap-x-4 gap-y-1 mt-1 text-slate-900 dark:text-white font-bold text-lg"
            >
              <div>
                <span
                  id="c-roles"
                  class="text-blue-600 dark:text-blue-400 text-2xl mr-1"
                  >0</span
                ><span class="text-sm text-slate-400">역할</span>
              </div>
              <div class="w-px h-3 bg-slate-200 dark:bg-slate-700"></div>
              <div>
                <span
                  id="c-disable"
                  class="text-slate-700 dark:text-slate-300 mr-1"
                  >0</span
                ><span class="text-sm text-slate-400">비활성</span>
              </div>
              <div class="w-px h-3 bg-slate-200 dark:bg-slate-700"></div>
              <div>
                <span
                  id="c-reset"
                  class="text-slate-700 dark:text-slate-300 mr-1"
                  >0</span
                ><span class="text-sm text-slate-400">초기화</span>
              </div>
              <div class="w-px h-3 bg-slate-200 dark:bg-slate-700"></div>
              <div>
                <span id="c-delete" class="text-rose-500 mr-1">0</span
                ><span class="text-sm text-slate-400">삭제</span>
              </div>
            </div>
            <div
              class="absolute inset-0 bg-blue-500/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"
            ></div>
          </div>

          <div
            class="card flex flex-col justify-center gap-1 p-5 relative overflow-hidden group"
          >
            <div class="text-sm font-bold text-slate-500 dark:text-slate-400">
              최근 7일 변동
            </div>
            <div
              class="flex flex-wrap items-baseline gap-x-4 gap-y-1 mt-1 text-slate-900 dark:text-white font-bold text-lg"
            >
              <div>
                <span
                  id="c7-roles"
                  class="text-blue-600 dark:text-blue-400 text-2xl mr-1"
                  >0</span
                ><span class="text-sm text-slate-400">역할</span>
              </div>
              <div class="w-px h-3 bg-slate-200 dark:bg-slate-700"></div>
              <div>
                <span
                  id="c7-disable"
                  class="text-slate-700 dark:text-slate-300 mr-1"
                  >0</span
                ><span class="text-sm text-slate-400">비활성</span>
              </div>
              <div class="w-px h-3 bg-slate-200 dark:bg-slate-700"></div>
              <div>
                <span
                  id="c7-reset"
                  class="text-slate-700 dark:text-slate-300 mr-1"
                  >0</span
                ><span class="text-sm text-slate-400">초기화</span>
              </div>
              <div class="w-px h-3 bg-slate-200 dark:bg-slate-700"></div>
              <div>
                <span id="c7-delete" class="text-rose-500 mr-1">0</span
                ><span class="text-sm text-slate-400">삭제</span>
              </div>
            </div>
            <div
              class="absolute inset-0 bg-indigo-500/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"
            ></div>
          </div>
        </div>

        <section class="card space-y-4">
          <div class="flex flex-col lg:flex-row gap-3 items-end">
            <div class="field-group flex-1">
              <label class="field-label">검색</label>
              <div class="field-box">
                <div class="field-prefix"><i class="fas fa-search"></i></div>
                <input
                  id="q"
                  type="text"
                  class="field-input"
                  placeholder="이메일, 이름, UID 검색 (Enter)"
                />
                <div class="field-right">
                  <button
                    id="btn-reset-filters"
                    class="btn btn-ghost w-8 h-8 rounded-full text-slate-400 hover:text-slate-600"
                    title="필터 초기화"
                  >
                    <i class="fas fa-times-circle"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="flex gap-3 w-full lg:w-auto">
              <div class="field-group w-1/2 lg:w-36">
                <label class="field-label">역할</label>
                <div class="field-box">
                  <select id="f-role" class="field-input">
                    <option value="">전체</option>
                    <option value="admin">Admin</option>
                    <option value="user">User</option>
                    <option value="pending">Pending</option>
                  </select>
                </div>
              </div>
              <div class="field-group w-1/2 lg:w-40">
                <label class="field-label">로그인 수단</label>
                <div class="field-box">
                  <input
                    id="f-provider"
                    type="text"
                    class="field-input"
                    placeholder="ex: google"
                  />
                </div>
              </div>
            </div>

            <div class="field-group w-full lg:w-40">
              <label class="field-label">정렬</label>
              <div class="field-box">
                <select id="f-sort" class="field-input">
                  <option value="lastSignInTime:desc">최근로그인 ↓</option>
                  <option value="lastSignInTime:asc">최근로그인 ↑</option>
                  <option value="email:asc">이메일 ↑</option>
                  <option value="email:desc">이메일 ↓</option>
                </select>
              </div>
            </div>

            <button
              id="btn-search"
              class="btn btn-primary btn-md w-full lg:w-auto mt-2 lg:mt-0"
            >
              검색
            </button>
          </div>

          <div
            class="flex flex-col sm:flex-row flex-wrap gap-3 items-center justify-between bg-slate-50 dark:bg-slate-800/50 p-3 rounded-2xl border border-slate-100 dark:border-slate-700/50"
          >
            <div class="flex items-center gap-2 w-full sm:w-auto">
              <div
                class="text-sm font-bold text-slate-500 whitespace-nowrap pl-2"
              >
                선택
                <span id="sel-count" class="text-blue-600 dark:text-blue-400"
                  >0</span
                >명
              </div>
              <div class="h-4 w-px bg-slate-300 dark:bg-slate-600 mx-1"></div>

              <div
                class="field-box !h-9 w-full sm:w-40 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700"
              >
                <select id="bulk-role" class="field-input text-sm py-0">
                  <option value="">역할 일괄 변경...</option>
                  <option value="admin">Admin</option>
                  <option value="user">User</option>
                  <option value="pending">Pending</option>
                </select>
              </div>
              <button
                id="btn-bulk-role"
                class="btn btn-light btn-sm whitespace-nowrap"
              >
                적용
              </button>
            </div>

            <div
              id="bulk-actions"
              class="flex flex-wrap gap-2 w-full sm:w-auto justify-end opacity-50 pointer-events-none transition-opacity duration-200"
            >
              <button
                id="btn-disable"
                class="btn btn-light-weak btn-sm text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20"
              >
                비활성
              </button>
              <button
                id="btn-enable"
                class="btn btn-light-weak btn-sm text-emerald-600 hover:bg-emerald-50 dark:hover:bg-emerald-900/20"
              >
                활성
              </button>
              <button id="btn-reset" class="btn btn-light-weak btn-sm">
                PW초기화
              </button>
              <button id="btn-revoke" class="btn btn-light-weak btn-sm">
                강제로그아웃
              </button>
              <button
                id="btn-export-xlsx"
                class="btn btn-outline btn-sm bg-white dark:bg-slate-800 pointer-events-auto opacity-100"
              >
                <i class="fas fa-file-excel text-emerald-600"></i> 내보내기
              </button>
            </div>
          </div>

          <div
            class="table-wrap overflow-y-auto max-h-[600px] custom-scrollbar rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800"
          >
            <table id="admin-user-table" class="table w-full">
              <thead
                class="sticky top-0 z-10 bg-slate-50 dark:bg-slate-900 shadow-sm"
              >
                <tr>
                  <th class="w-12 text-center py-3">
                    <div class="flex items-center justify-center">
                      <input id="chk-all" type="checkbox" class="input-toss" />
                    </div>
                  </th>
                  <th>이메일</th>
                  <th>이름</th>
                  <th class="w-32">역할</th>
                  <th>최근 로그인</th>
                  <th>수단</th>
                  <th class="w-20 text-center">상태</th>
                  <th class="w-24 text-center">관리</th>
                </tr>
              </thead>
              <tbody
                id="admin-user-tbody"
                class="divide-y divide-slate-100 dark:divide-slate-700/50"
              >
                <tr>
                  <td colspan="8" class="text-center py-12 text-slate-400">
                    검색 후 결과가 표시됩니다.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="flex justify-center pt-2">
            <button
              id="btn-more"
              class="btn btn-light btn-md w-full sm:w-auto px-8"
              style="display: none"
            >
              더 보기
            </button>
          </div>
        </section>

        <section class="card" id="logs-card">
          <div
            class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-end mb-4"
          >
            <h3
              class="text-lg font-bold text-slate-800 dark:text-slate-200 flex items-center gap-2"
            >
              <i class="fas fa-history text-slate-400"></i> 감사 로그
              <span class="text-sm font-normal text-slate-500"
                >(최근 60일)</span
              >
            </h3>
            <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
              <div class="field-box !h-9 w-full sm:w-48">
                <input
                  id="log-uid"
                  class="field-input text-sm"
                  type="text"
                  placeholder="UID (선택) + Enter"
                />
              </div>
              <div class="field-box !h-9 w-full sm:w-40">
                <select id="log-action" class="field-input text-sm py-0">
                  <option value="">모든 액션</option>
                  <option value="setRole">역할 설정</option>
                  <option value="setRoleBulk">다량 역할 설정</option>
                  <option value="disableUser">사용자 비활성</option>
                  <option value="enableUser">사용자 활성</option>
                  <option value="forcePasswordReset">비밀번호 초기화</option>
                </select>
              </div>
              <button id="btn-logs" class="btn btn-dark btn-sm px-4">
                조회
              </button>
            </div>
          </div>

          <div
            class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700"
          >
            <table class="table w-full" id="logs-table">
              <thead>
                <tr>
                  <th class="whitespace-nowrap">시각</th>
                  <th class="whitespace-nowrap">행위자</th>
                  <th class="whitespace-nowrap">액션</th>
                  <th class="whitespace-nowrap">대상</th>
                  <th class="whitespace-nowrap">상태</th>
                </tr>
              </thead>
              <tbody id="logs-tbody">
                <tr>
                  <td colspan="5" class="text-center py-8 text-slate-400">
                    조건을 선택하고 조회하세요.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <section id="approvals-card" class="space-y-6" hidden>
        <div class="card space-y-4">
          <div
            class="flex flex-col sm:flex-row justify-between items-center gap-4 border-b border-slate-100 dark:border-slate-700/50 pb-4"
          >
            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200">
              승인 요청 목록
            </h3>
            <div class="flex gap-2 w-full sm:w-auto">
              <button id="apr-refresh" class="btn btn-light btn-sm">
                <i class="fas fa-sync-alt"></i>
              </button>
              <button id="apr-approve" class="btn btn-primary-weak btn-sm">
                선택 승인
              </button>
              <button id="apr-reject" class="btn btn-danger-weak btn-sm">
                선택 거부
              </button>
            </div>
          </div>
          <div
            class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800"
          >
            <table class="table w-full" id="approvals-table">
              <thead>
                <tr>
                  <th class="w-12 text-center py-3">
                    <div class="flex items-center justify-center">
                      <input type="checkbox" id="apr-all" class="input-toss" />
                    </div>
                  </th>
                  <th class="whitespace-nowrap">요청시각</th>
                  <th class="whitespace-nowrap">요청자</th>
                  <th class="whitespace-nowrap">유형</th>
                  <th class="whitespace-nowrap">대상</th>
                  <th class="min-w-[200px]">내용</th>
                  <th class="text-center">작업</th>
                </tr>
              </thead>
              <tbody
                id="approvals-tbody"
                class="divide-y divide-slate-100 dark:divide-slate-700/50"
              >
                <tr>
                  <td colspan="7" class="text-center py-12 text-slate-400">
                    대기중인 요청이 없습니다.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="card" id="annual-card">
        <div class="flex flex-col gap-4">
          <div
            class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-b border-slate-100 dark:border-slate-700/50 pb-4"
          >
            <div>
              <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200">
                연간 백업 및 데이터 정리
              </h3>
              <p class="text-sm text-slate-500 mt-1">
                지정된 기간의 데이터를 백업하거나 영구 삭제합니다.
              </p>
            </div>
            <button id="btn-annual-default" class="btn btn-light btn-sm">
              전년도 3/1 ~ 당해 3/1 설정
            </button>
          </div>
          <div
            class="flex flex-col md:flex-row gap-4 items-center bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl"
          >
            <div class="flex items-center gap-2 w-full md:w-auto">
              <span
                class="text-sm font-bold text-slate-600 dark:text-slate-400 shrink-0"
                >기간</span
              >
              <div
                class="field-box !h-10 w-full md:w-44 bg-white dark:bg-slate-900"
              >
                <div class="field-prefix"><i class="far fa-calendar"></i></div>
                <input
                  id="yr-start"
                  type="text"
                  class="field-input text-center"
                  placeholder="YYYY.MM.DD"
                />
              </div>
              <span class="text-slate-400 font-bold">~</span>
              <div
                class="field-box !h-10 w-full md:w-44 bg-white dark:bg-slate-900"
              >
                <div class="field-prefix"><i class="far fa-calendar"></i></div>
                <input
                  id="yr-end"
                  type="text"
                  class="field-input text-center"
                  placeholder="YYYY.MM.DD"
                />
              </div>
            </div>
            <div class="flex gap-2 w-full md:w-auto md:ml-auto">
              <button
                id="btn-export-provisions-year"
                class="btn btn-outline btn-sm bg-white dark:bg-slate-800 flex-1"
              >
                제공 내역 백업
              </button>
              <button
                id="btn-export-visits-year"
                class="btn btn-outline btn-sm bg-white dark:bg-slate-800 flex-1"
              >
                방문 기록 백업
              </button>
            </div>
          </div>
          <div
            class="border-t border-slate-100 dark:border-slate-700/50 pt-4 mt-2"
          >
            <div
              class="flex flex-col md:flex-row gap-3 items-center justify-between"
            >
              <p class="text-xs text-rose-500 font-bold">
                <i class="fas fa-exclamation-triangle mr-1"></i> 주의: 데이터
                삭제는 되돌릴 수 없습니다. 반드시 XLSX 백업을 먼저 수행하세요.
              </p>
              <div class="flex gap-2 w-full md:w-auto">
                <div
                  class="field-box !h-9 w-full md:w-64 border-rose-200 dark:border-rose-900 bg-rose-50 dark:bg-rose-950/30"
                >
                  <input
                    id="purge-confirm"
                    class="field-input text-sm text-rose-600 placeholder-rose-300"
                    placeholder="확인 문구: DELETE-DATA"
                  />
                </div>
                <button
                  id="btn-purge-run"
                  class="btn btn-danger btn-sm whitespace-nowrap"
                >
                  데이터 영구 삭제
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div id="footer-container"></div>

    <script type="module">
      import { loadHeader, loadFooter } from "./js/components/comp.js";
      import "./js/admin.js";
      loadHeader("header-container");
      loadFooter("footer-container");
    </script>
  </body>
</html>
