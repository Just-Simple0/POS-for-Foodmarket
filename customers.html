<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POS System - Customers</title>
    <!-- 공통 parts 삽입 -->
    <link rel="stylesheet" href="css/common.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.min.css"
    />
    <script>
      window.CF_TURNSTILE_SITEKEY = "0x4AAAAAABtE3GFMWF3_Fd4E";
    </script>
    <!-- SheetUS 삽입 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- firebase parts 삽입 -->
    <script type="module" src="js/components/firebase-config.js"></script>
    <!-- 개별 css, js 삽입 -->
    <link rel="stylesheet" href="css/customers.css" />
    <script type="module" src="js/customers.js" defer></script>
  </head>
  <body>
    <div id="header-container"></div>

    <main class="container">
      <h2>이용자 조회</h2>
      <div id="top-bar">
        <div class="search-bar">
          <input
            id="global-search"
            placeholder="이름/행정구역 접두 또는 전화 숫자"
          />
          <button id="btn-run-search" class="btn">검색</button>
          <button id="toggle-advanced-search" class="btn btn-ghost">
            고급 검색 열기
          </button>
        </div>
        <!-- 로컬 캐시 0건 시 서버 필드 검색 유도 배너 -->
        <div
          id="search-hint"
          class="search-hint hidden"
          aria-live="polite"
        ></div>

        <div id="advanced-search" class="hidden">
          <select id="field-select">
            <option value="">필드 선택</option>
            <option value="name">이용자명</option>
            <option value="birth">생년월일</option>
            <option value="gender">성별</option>
            <option value="status">상태</option>
            <option value="region1">행정구역</option>
            <option value="address">주소</option>
            <option value="phone">전화번호</option>
            <option value="type">이용자구분</option>
            <option value="category">이용자분류</option>
          </select>
          <input id="field-search" placeholder="선택 필드 검색" />
          <button id="btn-run-field-search" class="btn">조회</button>
        </div>
      </div>

      <div class="list-header">
        <h2>이용자 목록</h2>
        <!-- 상단 툴바 -->
        <div class="customers-toolbar">
          <div class="left">
            <button id="btn-customer-create" class="btn btn-primary">
              <i class="fas fa-user-plus"></i> 등록하기
            </button>
            <button id="btn-export-xlsx" class="btn">
              <i class="fas fa-file-export"></i> 내보내기
            </button>
          </div>
          <div class="right admin-only" title="관리자 전용">
            <!-- 선택 삭제는 이후 확장 가능, 일단 행별 삭제 아이콘 제공 -->
          </div>
        </div>
      </div>

      <div class="table-wrapper">
        <table id="customer-table">
          <thead id="customers-thead">
            <tr>
              <th data-label="이용자명">이용자명</th>
              <th data-label="생년월일">생년월일</th>
              <th data-label="성별">성별</th>
              <th data-label="상태" class="th-admin-only">상태</th>
              <th data-label="행정구역">행정구역</th>
              <th data-label="주소">주소</th>
              <th data-label="전화번호">전화번호</th>
              <th data-label="이용자구분" class="th-admin-only">이용자구분</th>
              <th data-label="이용자분류" class="th-admin-only">이용자분류</th>
              <th data-label="최근 방문일자">최근 방문일자</th>
              <th data-label="비고">비고</th>
              <th data-label="작업" class="th-actions">작업</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="pagination" class="pagination"></div>
    </main>

    <!-- 등록하기 모달 (직접 입력 / 엑셀 업로드) -->
    <div
      id="customer-create-modal"
      class="modal hidden modal--customer"
      aria-hidden="true"
    >
      <div
        class="modal-content"
        role="dialog"
        aria-modal="true"
        aria-labelledby="create-modal-title"
      >
        <div class="modal-header">
          <h2 id="create-modal-title">
            <i class="fas fa-user-plus"></i> 이용자 등록
          </h2>
        </div>
        <div class="modal-body">
          <div class="tabs">
            <button class="tab active" data-tab="direct">직접 입력</button>
            <button class="tab" data-tab="upload">엑셀 업로드</button>
          </div>
          <div class="tab-panel" id="tab-direct">
            <!-- 사진처럼 2열 그리드 배치 -->
            <div class="form-grid">
              <label
                ><span>이름</span><input id="create-name" type="text"
              /></label>
              <label
                ><span>생년월일</span
                ><input id="create-birth" type="text" placeholder="YYYY.MM.DD"
              /></label>

              <label
                ><span>성별</span>
                <select id="create-gender">
                  <option value="">선택</option>
                  <option>남</option>
                  <option>여</option>
                </select>
              </label>
              <label
                ><span>상태</span>
                <select id="create-status">
                  <option>지원</option>
                  <option>중단</option>
                  <option>제외</option>
                  <option>사망</option>
                </select>
              </label>

              <label class="col-2"
                ><span>행정구역</span
                ><input
                  id="create-region1"
                  type="text"
                  placeholder="예: 두류1,2동"
              /></label>
              <label class="col-2"
                ><span>주소</span><input id="create-address" type="text"
              /></label>

              <!-- 전화번호(여러 개 입력 + 버튼) -->
              <div class="col-2">
                <div class="label-row">
                  <span>전화번호</span>
                  <button
                    type="button"
                    id="create-phone-add"
                    class="btn btn-ghost phone-add"
                  >
                    + 추가
                  </button>
                </div>
                <div id="create-phone-wrap" class="phone-list">
                  <!-- 동적 입력줄 -->
                </div>
              </div>

              <label
                ><span>이용자구분</span>
                <input
                  id="create-type"
                  type="text"
                  list="type-options"
                  placeholder="선택 또는 직접 입력"
                />
              </label>
              <label
                ><span>이용자분류</span>
                <input
                  id="create-category"
                  type="text"
                  list="category-options"
                  placeholder="선택 또는 직접 입력"
                />
              </label>

              <label class="col-2"
                ><span>비고</span><input id="create-note" type="text"
              /></label>
            </div>
            <div class="modal-buttons">
              <button
                type="button"
                id="create-modal-save"
                class="btn btn-primary"
              >
                <i class="fas fa-save"></i> 저장
              </button>
              <button type="button" id="create-modal-close" class="btn">
                닫기
              </button>
            </div>
          </div>

          <div class="tab-panel hidden" id="tab-upload">
            <div class="uploader">
              <input type="file" id="upload-file" accept=".xlsx,.xls" />
              <div class="upload-options">
                <label
                  ><input
                    type="checkbox"
                    id="opt-allow-missing-status"
                    checked
                  />
                  <span>상태 필드 없어도 업로드 허용</span></label
                >
                <fieldset>
                  <legend>상태 변경</legend>
                  <label
                    ><input
                      type="radio"
                      name="opt-status-mode"
                      value="none"
                      checked
                    />
                    <span>변경 없음</span></label
                  >
                  <label
                    ><input
                      type="radio"
                      name="opt-status-mode"
                      value="all-support"
                    />
                    <span>업로드 전원 ‘지원’</span></label
                  >
                  <label
                    title="업로드 전원 ‘지원’으로 저장하고, 이번 업로드에 포함되지 않은 기존 ‘지원’ 인원은 모두 ‘중단’으로 변경"
                  >
                    <input
                      type="radio"
                      name="opt-status-mode"
                      value="all-support-stop-others"
                    />
                    <span
                      >업로드 전원 ‘지원’ 및 업로드 <b style="color: red;">제외</b>된 인원
                      <b style="color: red;">‘중단’</b></span
                    >
                  </label>
                </fieldset>
              </div>
              <div class="upload-preview" id="upload-preview"></div>
              <div class="modal-buttons upload-actions">
                <button class="btn" id="btn-upload-dryrun">
                  <i class="fas fa-eye"></i> 미리보기
                </button>
                <button class="btn btn-primary" id="btn-upload-exec" disabled>
                  <i class="fas fa-cloud-upload-alt"></i> 실행
                </button>
                <button type="button" id="create-modal-close" class="btn">
                  닫기
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="edit-modal" class="modal hidden">
      <form
        id="edit-form"
        class="modal-content"
        role="dialog"
        aria-modal="true"
        aria-label="edit-title"
      >
        <h2 id="edit-title"><i class="fas fa-edit"></i> 이용자 정보 수정</h2>

        <input type="hidden" id="edit-id" />
        <div class="form-grid">
          <label><span>이름</span><input id="edit-name" /></label>
          <label
            ><span>생년월일</span
            ><input id="edit-birth" type="text" placeholder="YYYY.MM.DD"
          /></label>

          <label
            ><span>성별</span>
            <select id="edit-gender">
              <option value="">선택</option>
              <option>남</option>
              <option>여</option>
            </select>
          </label>
          <label
            ><span>상태</span>
            <select id="edit-status">
              <option>지원</option>
              <option>중단</option>
              <option>제외</option>
              <option>사망</option>
            </select>
          </label>

          <label class="col-2"
            ><span>행정구역</span><input id="edit-region1"
          /></label>
          <label class="col-2"
            ><span>주소</span><input id="edit-address"
          /></label>

          <div class="col-2">
            <div class="label-row">
              <span>전화번호</span>
              <button
                type="button"
                id="edit-phone-add"
                class="btn btn-ghost phone-add"
              >
                + 추가
              </button>
            </div>
            <div id="edit-phone-wrap" class="phone-list"></div>
          </div>

          <label
            ><span>이용자구분</span>
            <input
              id="edit-type"
              type="text"
              list="type-options"
              placeholder="선택 또는 직접 입력"
            />
          </label>
          <label
            ><span>이용자분류</span>
            <input
              id="edit-category"
              type="text"
              list="category-options"
              placeholder="선택 또는 직접 입력"
            />
          </label>

          <label class="col-2"><span>비고</span><input id="edit-note" /></label>
        </div>

        <div class="modal-buttons">
          <button type="submit"><i class="fas fa-save"></i> 저장</button>
          <button type="button" id="close-edit-modal">
            <i class="fas fa-times"></i> 취소
          </button>
        </div>
      </form>
    </div>

    <!-- ===== datalist (공용) : 선택지 + 자유입력 ===== -->
    <datalist id="type-options">
      <option value="긴급지원대상자"></option>
      <option value="기초생활보장수급자"></option>
      <option value="차상위계층"></option>
      <option value="저소득층"></option>
      <option value="기초생활보장수급탈락자"></option>
    </datalist>
    <datalist id="category-options">
      <option value="결식아동"></option>
      <option value="다분화가정"></option>
      <option value="독거어르신"></option>
      <option value="소년소녀가장"></option>
      <option value="외국인노동자"></option>
      <option value="재가장애인"></option>
      <option value="저소득가정"></option>
      <option value="조손가정"></option>
      <option value="한부모가정"></option>
      <option value="기타"></option>
      <option value="청장년1인가구"></option>
      <option value="미혼모부가구"></option>
      <option value="부부중심가구"></option>
      <option value="노인부부가구"></option>
      <option value="새터민가구"></option>
      <option value="공통체가구"></option>
    </datalist>

    <!-- 동명이인 처리 모달 -->
    <div id="dup-modal" class="modal hidden" aria-hidden="true">
      <div
        class="modal-content"
        role="dialog"
        aria-modal="true"
        aria-labelledby="dup-modal-title"
      >
        <div class="modal-header">
          <h2 id="dup-modal-title">동명이인 처리</h2>
        </div>
        <div class="modal-body">
          <p id="dup-info" style="margin-bottom: 10px"></p>
          <ol style="margin: 0 0 8px 18px">
            <li><b>기존 정보 업데이트</b> — 기존 문서에 입력한 값으로 갱신</li>
            <li>
              <b>동명이인 신규로 등록</b> — 동일한 이름·생년월일로 새 문서 추가
            </li>
          </ol>
        </div>
        <div class="modal-footer">
          <button id="dup-update" class="btn btn-primary">
            기존 정보 업데이트
          </button>
          <button id="dup-new" class="btn">동명이인 신규로 등록</button>
          <button class="btn" data-close>취소</button>
        </div>
      </div>
    </div>

    <div id="footer-container"></div>

    <!-- header footer 삽입 -->
    <script type="module">
      import { loadHeader, loadFooter } from "./js/components/comp.js";
      loadHeader("header-container");
      loadFooter("footer-container");
    </script>
  </body>
</html>
